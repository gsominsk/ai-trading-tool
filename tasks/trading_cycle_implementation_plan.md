# План Реализации TradingCycle

Этот план описывает пошаговую реализацию упрощенного торгового движка, состоящего из 4 ключевых модулей. Разработка разделена на фазы, где каждая фаза включает в себя разработку, тестирование и один финальный коммит.

---

### **Принципы Рабочего Процесса**

1.  **Фазовая Разработка:** Работа сгруппирована в логические фазы.
2.  **Сначала Код, Потом Тесты:** В рамках одной подзадачи сначала пишется код, затем создается/обновляется тест.
3.  **Один Коммит на Фазу:** Чтобы избежать "коммит-спама", все изменения, сделанные в рамках одной фазы, объединяются в один коммит с осмысленным сообщением.
4.  **Тестирование Контрактов:** Тесты должны проверять не просто существование файлов, а "контракты" — корректность интерфейсов, методов, структур данных и т.д.
5.  **Регулярные Обновления MB:** Memory Bank обновляется после завершения каждой крупной подзадачи.

---

### **Фаза 1: Фундамент и Контракты**

**Цель:** Создать базовую структуру, определить "контракты" (интерфейсы) модулей и написать тесты, которые эти контракты проверяют. На этом этапе мы используем заглушки вместо реальной логики.

*   **1.1: Структура `trade_log.csv`**
    *   **Действие:** Создать файл `data/trade_log.csv` и определить в нем заголовок (например, `timestamp,order_id,symbol,type,price,quantity,status`).
    *   **Тест:** Создать `tests/integration/trading/test_phase1_contracts.py`, который проверяет, что `trade_log.csv` существует и его заголовок соответствует ожидаемому.

*   **1.2: Контракт `OrderManagementSystem`**
    *   **Действие:** В `src/trading/oms.py` создать класс `OrderManagementSystem` с методами-заглушками (`place_order`, `cancel_order`, `get_order_status`), которые возвращают `NotImplementedError`.
    *   **Тест:** Дополнить `test_phase1_contracts.py` тестом, который проверяет, что класс `OMS` существует и имеет все необходимые методы.

*   **1.3: Контракт `TradingCycle`**
    *   **Действие:** В `src/trading/trading_cycle.py` создать класс `TradingCycle` с методом `__init__`, принимающим `oms` и `market_data_service`, и пустым методом `run_cycle`.
    *   **Тест:** Дополнить `test_phase1_contracts.py` тестом, который проверяет, что класс `TradingCycle` создается и имеет метод `run_cycle`.

*   **1.4: Финализация Фазы**
    *   **Действие:** Запустить все тесты и убедиться, что они проходят.
    *   **Действие:** Обновить Memory Bank (`activeContext.md`, `progress.md`).
    *   **Коммит:** Сделать коммит с сообщением `feat(trading): establish phase 1 contracts and stubs`.

---

### **Фаза 2: Реализация Ядра `TradingCycle`**

**Цель:** Реализовать основную логику внутри `TradingCycle`, используя заглушки для внешних зависимостей (OMS, MarketData).

*   **2.1: Работа с `trade_log.csv`**
    *   **Действие:** Реализовать внутренние методы `_get_current_position` (читает последнюю запись из лога) и `_update_log` (добавляет новую запись).
    *   **Тест:** Создать `tests/unit/trading/test_trading_cycle_logic.py` для модульного тестирования этих методов.

*   **2.2: Логика Синхронизации Статуса**
    *   **Действие:** Реализовать часть `run_cycle`, отвечающую за проверку статуса "зависших" ордеров через `oms.get_order_status`.
    *   **Тест:** Дополнить `test_trading_cycle_logic.py`, используя mock для `OMS`, чтобы проверить логику синхронизации.

*   **2.3: Взаимодействие с ИИ (Заглушка)**
    *   **Действие:** Реализовать метод `_get_ai_decision`, который формирует промпт и возвращает жестко закодированное решение (например, "BUY").
    *   **Тест:** Дополнить `test_trading_cycle_logic.py` тестом, проверяющим, что метод корректно формирует промпт.

*   **2.4: Оркестрация и Вызов OMS**
    *   **Действие:** Реализовать основную логику `run_cycle`, которая вызывает все внутренние методы по порядку и в конце вызывает `oms.place_order`.
    *   **Тест:** Дополнить `test_trading_cycle_logic.py` интеграционным тестом (в рамках юнита), который проверяет полный цикл вызовов с mock-объектами.

*   **2.5: Финализация Фазы**
    *   **Действие:** Запустить все тесты.
    *   **Действие:** Обновить Memory Bank.
    *   **Коммит:** Сделать коммит с сообщением `feat(trading): implement core TradingCycle logic`.

---

### **Фаза 3: Рефакторинг Персистентности и Интеграция**

**Цель:** Решить проблему отсутствия состояния `OMS` между запусками путем внедрения паттерна "Репозиторий" и провести интеграционное тестирование.

*   **3.1: Реализация `OrderRepository`**
    *   **Действие:** В новом файле `src/trading/repository.py` создать класс `OrderRepository`, отвечающий за `load/save` состояния ордеров в `data/oms_state.json`.
    *   **Тест:** Создать юнит-тесты в `tests/unit/trading/test_repository.py` для проверки логики сохранения и загрузки.

*   **3.2: Рефакторинг `OrderManagementSystem`**
    *   **Действие:** Изменить `OMS` для работы с `OrderRepository` через Dependency Injection. `OMS` больше не будет знать о файлах, а будет делегировать сохранение/загрузку репозиторию.
    *   **Тест:** Адаптировать существующие интеграционные тесты (`tests/integration/trading/test_trading_cycle_integration.py`) для работы с новой архитектурой.

*   **3.3: Адаптация Скрипта Ручного Тестирования**
    *   **Действие:** Обновить скрипт `dev-tools/manual-tests/run_manual_trading_cycle.py` так, чтобы он правильно инициализировал `OrderRepository` и `OMS` и передавал их в `TradingCycle`.

*   **3.4: Финализация Фазы**
    *   **Действие:** Провести ручное тестирование, чтобы убедиться, что состояние ордера (`PENDING` -> `FILLED`) сохраняется между запусками скрипта.
    *   **Действие:** Запустить все тесты (`pytest`).
    *   **Действие:** Обновить Memory Bank по итогам Фазы 3.
    *   **Коммит:** Сделать коммит с сообщением `feat(trading): implement repository pattern for OMS persistence`.