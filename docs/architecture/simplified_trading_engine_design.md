# Архитектура торгового движка: Динамический исполнитель

Этот документ описывает архитектуру торгового движка, основанную на концепции, где ИИ выступает в роли динамического стратега, а система — в роли исполнителя, постоянно управляющего жизненным циклом ордеров.

## Ключевая концепция

Система не просто размещает ордера, а **постоянно переоценивает** ситуацию для каждого актива. В каждом цикле ИИ получает свежие рыночные данные и **полную информацию о текущем состоянии** (наличие открытых позиций или неисполненных ордеров) и принимает решение: открыть новую позицию, изменить существующую, отменить неактуальную или ничего не делать.

---

## 1. Форматы ответов от ИИ

ИИ должен возвращать команды в строгом JSON-формате.

**1.1. Команда на создание нового торгового плана**
```json
{
  "action": "PLAN_TRADE",
  "trade_setup": {
    "symbol": "BTCUSDT",
    "direction": "LONG",
    "entry_price": 65000.00,
    "stop_loss_price": 63500.00,
    "take_profit_prices": [67000.00, 69000.00],
    "position_size_percent": 10
  }
}
```

**1.2. Команда на отмену неисполненного ордера**
```json
{
  "action": "CANCEL_ORDER",
  "order_id": "123456789",
  "reasoning": "Рыночные условия изменились, точка входа больше не актуальна."
}
```

**1.3. Команда на корректировку активной сделки**
```json
{
  "action": "ADJUST_TRADE",
  "order_id": "987654321",
  "new_stop_loss_price": 65100.00,
  "reasoning": "Перемещаем стоп-лосс в безубыток для защиты прибыли."
}
```

**1.4. Команда ничего не делать**
```json
{
  "action": "DO_NOTHING"
}
```

---

## 2. Управляющий цикл (Scheduler)

**Компонент:** `main.py`
**Периодичность:** Запускается каждые 15 минут.

**Логика:**
1.  **Загрузка конфигурации:** Читает список торговых пар из `config/trading_config.yaml`.
2.  **Итерация по активам:** Для каждой торговой пары (`symbol`) запускает основной торговый цикл.

---

## 3. Основной торговый цикл (для одного актива)

1.  **Сбор данных о состоянии:**
    *   **Локальный лог:** Система читает `data/trade_log.csv` и находит последнюю запись для `symbol`. Это определяет, есть ли `PENDING` ордер или `ACTIVE` позиция.
    *   **Рыночные данные:** Вызывается `MarketDataService.get_market_data()`.

2.  **Запрос к ИИ:**
    *   **Формируется промпт**, включающий свежие рыночные данные и **полный контекст о текущем состоянии** (например, "Активна позиция LONG по BTC, вход $65000, SL $63500. Что делать дальше?" или "Нет открытых позиций по ETH. Есть ли возможность для входа?").
    *   Промпт отправляется ИИ.

3.  **Исполнение команды через Order Management System (OMS):**
    *   Ответ ИИ передается в OMS, который выполняет соответствующее действие.

---

## 4. Система Управления Ордерами (Order Management System - OMS)

Это новый, критически важный модуль, который инкапсулирует всю логику взаимодействия с биржей.

**Обязанности OMS:**
*   **`execute_ai_command(command_json)`**: Главный метод, который принимает JSON от ИИ и вызывает нужный внутренний метод.

**Внутренние методы:**
*   **`place_new_trade_plan(trade_setup)`**:
    *   Валидирует план.
    *   Рассчитывает размер позиции.
    *   Размещает на бирже лимитный ордер на вход и связанный с ним OCO-ордер (SL/TP).
    *   Записывает сделку в `data/trade_log.csv` со статусом `PENDING`.

*   **`cancel_pending_order(order_id)`**:
    *   Находит ордер в `trade_log.csv`.
    *   Отправляет на биржу команду на отмену лимитного ордера и связанного OCO.
    *   Обновляет статус в логе на `CANCELLED`.

*   **`modify_active_trade(order_id, new_sl, new_tp)`**:
    *   Находит активную сделку в логе.
    *   Отменяет на бирже старый OCO-ордер.
    *   Размещает новый OCO-ордер с обновленными ценами.
    *   Обновляет информацию в `trade_log.csv`.

---

## 5. Мониторинг статуса ордеров

*   Для отслеживания исполнения ордеров (LIMIT, SL, TP) потребуется отдельный, более частый процесс (или WebSocket), который будет обновлять статусы (`PENDING` -> `ACTIVE` -> `CLOSED`) в `data/trade_log.csv`.

## Преимущества новой архитектуры

*   **Динамичность:** Система постоянно адаптируется к рынку, а не слепо следует устаревшим планам.
*   **Гибкость:** ИИ может не только открывать, но и активно управлять позициями (отменять, двигать стопы).
*   **Инкапсуляция:** Вся сложная логика работы с биржей скрыта внутри OMS, что делает остальной код чище.
*   **Надежность:** Четкое разделение ответственности между ИИ (стратегия), Scheduler (управление) и OMS (исполнение).