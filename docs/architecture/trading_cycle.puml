@startuml TradingCycle

title Trading Cycle Activity Diagram

start

:Start Cycle\nGenerate parent_trace_id;

if (log_repo.get_active_trade()) then (Yes)
    partition "Scenario B: Manage Trade" {
        :1. Get Market Data\n& Check Order Status;
    }
else (No)
    partition "Scenario A: New Trade" {
        :1. Get Market Data;
    }
endif

partition "AI Query & Retry Loop" {
    repeat
        :Attempt AI Request;
        if (Valid JSON Response?) then (Yes)
            break
        else (No)
            :Log Warning & Prepare Retry;
        endif
    repeat while (attempts < 3) is (Yes) not (No)
    
    if (Failed after 3 attempts?) then (Yes)
        :Log Critical Error;
        :Treat as DO_NOTHING;
        stop
    endif
}

partition "Process Valid AI Response" {
    switch (AI Action?)
    case (DO_NOTHING)
        stop
    case (PLAN_TRADE)
        if (Sanity Filter?) then (Accepted)
            :5. OMS: Create OCO Order;
            :6. Persistence: write_trade(PENDING);
        else (Rejected)
            :Log Rejection;
        endif
    case (ADJUST_TRADE / CANCEL_ORDER)
        :4. OMS: Adjust/Cancel Order;
        :5. Persistence: update_trade(status);
    endswitch
}

stop

@enduml