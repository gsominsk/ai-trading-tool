# Карта сценариев торгового цикла (с механизмом Retry)

Этот документ визуализирует все возможные пути и сценарии, которые могут возникнуть в течение одного торгового цикла, включая механизм повторных запросов к ИИ при невалидном ответе.

```ascii
                                                +-----------------------------+
                                                |   СТАРТ ЦИКЛА (для 1 актива)|
                                                |   Generate parent_trace_id  |
                                                +-----------------------------+
                                                             |
                                                             v
                                                +-----------------------------+
                                                |  ПРОВЕРКА СОСТОЯНИЯ         |
                                                |  log_repo.get_active_trade()|
                                                +-----------------------------+
                                                             |
                                                             |
                                 +---------------------------+---------------------------+
                                 |                                                       |
                                 v                                                       v
+--------------------------------------------------+      +--------------------------------------------------+
| СЦЕНАРИЙ A: НЕТ АКТИВНОЙ СДЕЛКИ                  |      | СЦЕНАРИЙ B: ЕСТЬ АКТИВНАЯ СДЕЛКА                 |
+--------------------------------------------------+      +--------------------------------------------------+
                                 |                                                       |
                                 v                                                       v
+--------------------------------------------------+      +--------------------------------------------------+
| 1. СБОР РЫНОЧНЫХ ДАННЫХ                          |      | 1. ОБНОВЛЕНИЕ ДАННЫХ                             |
|    MarketDataService.get_data()                  |      |    MarketDataService.get_data()                  |
+--------------------------------------------------+      |    OMS.check_order_status(trade)                 |
                                 |                        +--------------------------------------------------+
                                 |                                                       |
                                 +---------------------------+---------------------------+
                                                             |
                                                             v
                                          +------------------------------------+
                                          | 2. ЗАПРОС К ИИ И ВАЛИДАЦИЯ         |
                                          |    (Цикл с 3 попытками - Retry)    |
                                          +------------------------------------+
                                                             |
                                          +------------------+------------------+
                                          |                                     |
                                          v                                     v
+------------------------------------------------------+  +------------------------------------------------------+
| ПОПЫТКА #N:                                          |  | СБОЙ ПОСЛЕ 3 ПОПЫТОК:                                |
| - Отправка запроса к LLM                             |  | - Log Critical Error (все невалидные ответы)         |
|   (Если N>1, вкл. контекст ошибки: "Invalid JSON")   |  | - Treat as DO_NOTHING                                |
| - Парсинг ответа (try JSON)                          |  | - Increment failure counter (для Circuit Breaker)    |
+------------------------------------------------------+  +------------------------------------------------------+
                         |                                                       |
           +-------------+-------------+                                         |
           |                           |                                         |
           v                           v                                         |
+-------------------------+  +-------------------------+                         |
| УСПЕХ: Ответ валиден    |  | СБОЙ: Ответ невалиден   |                         |
| (JSON)                  |  | (N < 3)                 |                         |
+-------------------------+  +-------------------------+                         |
           |                           |                                         |
           |                           +------> (Возврат в начало цикла Retry) --+
           |
           v
+------------------------------------------------------+
| 3. ОБРАБОТКА ВАЛИДНОГО ОТВЕТА ИИ                     |
+------------------------------------------------------+
           |
   +-------+-------------+-------------+-------+
   |                     |             |       |
   v                     v             v       v
+-----------------+ +-----------------+ +--------------+ +--------------+
| ИИ:             | | ИИ:             | | ИИ:          | | ИИ:          |
| DO_NOTHING      | | PLAN_TRADE      | | ADJUST_TRADE | | CANCEL_ORDER |
+-----------------+ +-----------------+ +--------------+ +--------------+
        |                     |             |              |
        |                     v             v              v
        |         +-----------------------+ +------------------+
        |         | 4. "САНИТАРНЫЙ ФИЛЬТР"| | 4. OMS:          |
        |         |   (Проверка плана ИИ) | |    adjust/cancel |
        |         +-----------------------+ +------------------+
        |                     |             |
        |           +---------+---------+   |
        |           |                   |   |
        |           v                   v   v
        | +-----------------+   +-----------------+ +----------------------+
        | | План ОТКЛОНЕН   |   | План ПРИНЯТ     | | 5. ОБНОВЛЕНИЕ ЛОГА   |
        | +-----------------+   +-----------------+ | log_repo.update_trade|
        |         |                   |             +----------------------+
        |         |                   v
        |         |         +-------------------------+
        |         |         | 5. OMS: РАЗМЕЩЕНИЕ      |
        |         |         |    oms.create_oco_order() |
        |         |         +-------------------------+
        |         |                   |
        |         |                   v
        |         |         +-------------------------+
        |         |         | 6. ПЕРСИСТЕНТНОСТЬ      |
        |         |         | log_repo.write_trade()  |
        |         |         +-------------------------+
        |         |                   |
        +---------+-------------------+------------------------------------+
                  |
                  v
      +-------------------------+
      |   КОНЕЦ ЦИКЛА           |
      |   (для этого актива)    |
      +-------------------------+

```

### Ключевые моменты, отраженные на карте:

1.  **Механизм Retry:** Внедрен явный цикл повторных попыток (до 3 раз) для запросов к ИИ.
2.  **Обратная связь:** При невалидном ответе система не просто повторяет запрос, а добавляет контекст об ошибке (`"Invalid JSON, please correct"`), чтобы помочь ИИ исправиться.
3.  **Надежность:** Критическая ошибка фиксируется только после того, как все попытки исчерпаны. Это предотвращает ложные срабатывания из-за случайных сбоев ИИ.
4.  **Четкое разделение:** Логика разделена на сбор данных, цикл валидации ответа ИИ и последующую обработку валидного ответа.

Эта версия схемы наиболее полно и надежно описывает архитектуру торгового цикла.