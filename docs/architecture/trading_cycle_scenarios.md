# Карта сценариев торгового цикла

Этот документ визуализирует все возможные пути и сценарии, которые могут возникнуть в течение одного торгового цикла для одного актива.

```ascii
                                     +-------------------------+
                                     |   СТАРТ ЦИКЛА (15 мин)  |
                                     |   (для 1 актива)        |
                                     +-------------------------+
                                                |
                                                v
                                     +-------------------------+
                                     |  Проверка локального    |
                                     |  лога (trade_log.csv)   |
                                     +-------------------------+
                                                |
                  +-----------------------------+-----------------------------+
                  |                                                           |
                  v                                                           v
+------------------------------------+                      +------------------------------------+
| СЦЕНАРИЙ A:                          |                      | СЦЕНАРИЙ B:                          |
| Нет активных/ожидающих ордеров     |                      | Есть активная/ожидающая сделка     |
+------------------------------------+                      +------------------------------------+
                  |                                                           |
                  v                                                           v
      +-------------------------+                           +------------------------------------+
      |   Сбор рыночных данных  |                           |  Сбор рыночных данных + данных      |
      |   (MarketDataService)   |                           |  о сделке из локального лога        |
      +-------------------------+                           +------------------------------------+
                  |                                                           |
                  v                                                           v
      +-------------------------+                           +------------------------------------+
      |   Запрос к ИИ:          |                           |   Запрос к ИИ:                       |
      |   "Искать новый план?"  |                           |   "Что делать с текущей сделкой?"    |
      +-------------------------+                           +------------------------------------+
                  |                                                           |
+-----------------+-----------------+                           +-------------+-------------+-----------+
|                 |                 |                           |             |             |           |
v                 v                 v                           v             v             v           v
+-----------+   +---------------+   +-----------------+       +-----------+ +-----------+ +-----------+ +-----------+
| ИИ:       |   | ИИ:           |   | ИИ:             |       | ИИ:       | | ИИ:       | | ИИ:       | | ИИ:       |
| DO_NOTHING|   | PLAN_TRADE    |   | Ошибка/Таймаут  |       | DO_NOTHING| |ADJUST_TRADE| |CANCEL_ORDER| | Ошибка    |
+-----------+   +---------------+   +-----------------+       +-----------+ +-----------+ +-----------+ +-----------+
      |                 |                 |                           |             |             |           |
      |                 v                 v                           |             |             |           |
      |   +-------------------------+   +-----------------+           |             |             |           |
      |   |  "Санитарный фильтр"    |   | Circuit Breaker |           |             |             |           |
      |   |  (Проверка плана ИИ)    |   | (Остановить    |           |             |             |           |
      |   +-------------------------+   |  торговлю?)     |           |             |             |           |
      |                 |                 +-----------------+           |             |             |           |
      |       +---------+---------+                                     |             |             |           |
      |       |                   |                                     |             |             |           |
      |       v                   v                                     |             |             |           |
      | +---------------+   +---------------+                           |             |             |           |
      | | План ОТКЛОНЕН |   | План ПРИНЯТ   |                           |             |             |           |
      | +---------------+   +---------------+                           |             |             |           |
      |       |                   |                                     |             |             |           |
      |       |                   v                                     |             |             |           |
      |       |         +-------------------------+                     |             |             |           |
      |       |         |  OMS: Размещение ордеров|                     |             |             |           |
      |       |         |  (LIMIT + OCO)          |                     |             |             |           |
      |       |         +-------------------------+                     |             |             |           |
      |       |                   |                                     |             |             |           |
      |       |                   v                                     |             |             |           |
      |       |         +-------------------------+                     |             |             |           |
      |       |         |  Запись в trade_log.csv |                     |             |             |           |
      |       |         |  (статус PENDING)       |                     |             |             |           |
      |       |         +-------------------------+                     |             |             |           |
      |       |                   |                                     |             |             |           |
      +-------+-------------------+-------------------------------------+-------------+-------------+-----------+
              |                                                                       |             |
              v                                                                       v             v
+-------------------------+                                             +-----------+ +-----------+
|   КОНЕЦ ЦИКЛА           |                                             | OMS:      | | OMS:      |
|   (для этого актива)    |                                             | Изменить  | | Отменить  |
+-------------------------+                                             | ордер     | | ордер     |
                                                                        +-----------+ +-----------+
                                                                              |             |
                                                                              v             v
                                                                        +-------------------------+
                                                                        | Обновление trade_log.csv|
                                                                        +-------------------------+
                                                                              |
                                                                              v
                                                                        +-------------------------+
                                                                        |   КОНЕЦ ЦИКЛА           |
                                                                        |   (для этого актива)    |
                                                                        +-------------------------+

```

### Ключевые моменты, отраженные на карте:

1.  **Два главных сценария:** Цикл сразу разделяется в зависимости от того, есть ли уже сделка по активу.
2.  **Решения ИИ:** Показаны все возможные варианты ответов от ИИ для каждого сценария (`DO_NOTHING`, `PLAN_TRADE`, `ADJUST_TRADE`, `CANCEL_ORDER`).
3.  **"Санитарный фильтр":** Явно указан шаг проверки плана от ИИ перед его исполнением. Это защищает от "толстых пальцев" и нелогичных планов.
4.  **Circuit Breaker:** Учтен сценарий сбоя API ИИ, который может потребовать временной остановки торговли по активу.
5.  **OMS (Order Management System):** Все действия с биржей инкапсулированы в OMS, который вызывается после принятия решения.
6.  **Локальный лог:** `trade_log.csv` является центральным элементом, который читается в начале цикла и обновляется в конце.

Эта карта дает нам полное представление о потоке управления и помогает убедиться, что мы учли все основные ветвления логики.