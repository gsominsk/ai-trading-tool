# Карта сценариев торгового цикла (с механизмом Retry и статусом реализации)

Этот документ визуализирует все возможные пути и сценарии, которые могут возникнуть в течение одного торгового цикла, включая механизм повторных запросов к ИИ при невалидном ответе.

### Легенда статусов

*   `[###]` - **Implemented & Tested:** Компонент полностью реализован и протестирован.
*   `[#--]` - **Partially Implemented:** Компонент существует (например, как заглушка), но требует доработки.
*   `[---]` - **Not Implemented:** Компонент еще не реализован.

```ascii
                                                 +-----------------------------+
                                                 |   СТАРТ ЦИКЛА (для 1 актива)|
                                                 |   [###] Generate parent_trace_id  |
                                                 +-----------------------------+
                                                              |
                                                              v
                                                 +-----------------------------+
                                                 |  [###] ПРОВЕРКА СОСТОЯНИЯ   |
                                                 |  log_repo.get_active_trade()|
                                                 +-----------------------------+
                                                              |
                                                              |
                                  +---------------------------+---------------------------+
                                  |                                                       |
                                  v                                                       v
 +--------------------------------------------------+      +--------------------------------------------------+
 | СЦЕНАРИЙ A: НЕТ АКТИВНОЙ СДЕЛКИ                  |      | СЦЕНАРИЙ B: ЕСТЬ АКТИВНАЯ СДЕЛКА                 |
 +--------------------------------------------------+      +--------------------------------------------------+
                                  |                                                       |
                                  v                                                       v
 +--------------------------------------------------+      +--------------------------------------------------+
 | 1. [###] СБОР РЫНОЧНЫХ ДАННЫХ                    |      | 1. [###] ОБНОВЛЕНИЕ ДАННЫХ                       |
 |    MarketDataService.get_data()                  |      |    MarketDataService.get_data()                  |
 +--------------------------------------------------+      |    [###] OMS.check_order_status(trade)           |
                                  |                        +--------------------------------------------------+
                                  |                                                       |
                                  +---------------------------+---------------------------+
                                                              |
                                                              v
                                           +------------------------------------+
                                           | 2. [#--] ЗАПРОС К ИИ И ВАЛИДАЦИЯ   |
                                           |    (Цикл с 3 попытками - Retry)    |
                                           +------------------------------------+
                                                              |
                                           +------------------+------------------+
                                           |                                     |
                                           v                                     v
 +------------------------------------------------------+  +------------------------------------------------------+
 | [#--] ПОПЫТКА #N:                                    |  | [###] СБОЙ ПОСЛЕ 3 ПОПЫТОК:                          |
 | - Отправка запроса к LLM (заглушка)                  |  | - Log Critical Error (все невалидные ответы)         |
 | - Парсинг ответа (try JSON)                          |  | - Treat as DO_NOTHING                                |
 +------------------------------------------------------+  +------------------------------------------------------+
                          |                                                       |
            +-------------+-------------+                                         |
            |                           |                                         |
            v                           v                                         |
 +-------------------------+  +-------------------------+                         |
 | [#--] УСПЕХ: Ответ валиден|  | [#--] СБОЙ: Ответ невалиден|                         |
 | (JSON)                  |  | (N < 3)                 |                         |
 +-------------------------+  +-------------------------+                         |
            |                           |                                         |
            |                           +------> (Возврат в начало цикла Retry) --+
            |
            v
 +------------------------------------------------------+
 | 3. [###] ОБРАБОТКА ВАЛИДНОГО ОТВЕТА ИИ               |
 +------------------------------------------------------+
            |
    +-------+-------------+-------------+-------+
    |                     |             |       |
    v                     v             v       v
 +-----------------+ +-----------------+ +--------------+ +--------------+
 | [###] ИИ:       | | [#--] ИИ:       | | [###] ИИ:    | | [###] ИИ:    |
 | DO_NOTHING      | | PLAN_TRADE      | | ADJUST_TRADE | | CANCEL_ORDER |
 +-----------------+ +-----------------+ +--------------+ +--------------+
         |                     |             |              |
         |                     v             v              v
         |         +-----------------------+ +------------------+
         |         | [---] "САНИТАРНЫЙ ФИЛЬТР"| | [###] OMS:       |
         |         |   (Проверка плана ИИ) | |    adjust/cancel |
         |         +-----------------------+ +------------------+
         |                     |             |
         |           +---------+---------+   |
         |           |                   |   |
         |           v                   v   v
         | +-----------------+   +-----------------+ +----------------------+
         | | [---] План ОТКЛОНЕН |   | [---] План ПРИНЯТ | | [###] ОБНОВЛЕНИЕ ЛОГА|
         | +-----------------+   +-----------------+ | log_repo.update_trade|
         |         |                   |             +----------------------+
         |         |                   v
         |         |         +-------------------------+
         |         |         | [###] OMS: РАЗМЕЩЕНИЕ   |
         |         |         |    oms.create_oco_order() |
         |         |         +-------------------------+
         |         |                   |
         |         |                   v
         |         |         +-------------------------+
         |         |         | [###] ПЕРСИСТЕНТНОСТЬ   |
         |         |         | log_repo.write_trade()  |
         |         |         +-------------------------+
         |         |                   |
         +---------+-------------------+------------------------------------+
                   |
                   v
       +-------------------------+
       |   [###] КОНЕЦ ЦИКЛА     |
       |   (для этого актива)    |
       +-------------------------+
